<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
<script src="https://cdn.rawgit.com/calipho-sib/nextprot-js/v0.0.50/dist/nextprot.js"></script>

<ul>
<div id="txt" name="txt" method="post">
</div>
<form id="email_form" name="email_form" method="post" action="">
Email:
<input type="text" id="REPLY-E-MAIL" name="REPLY-E-MAIL" size=30>
<input type="submit" id="submit" value="Submit">
</form>
</ul>

<script type="text/JavaScript">
function IO(filename, input) 
{
    var fp = !window.XMLHttpRequest ? new ActiveXObject('Microsoft.XMLHTTP') : new XMLHttpRequest();
    fp.open(input ? 'PUT' : 'GET', filename, false );
    fp.setRequestHeader('Content-Type', 'text/html')
    fp.send(input ? input : '');
    return fp.responseText;
}
</script>

<script type="text/javascript">
/* create a neXtProt client instance. the two arguments are arbitrary */
var nx = new Nextprot.Client('I-TASSER/COFACTOR', 'Yang Zhang lab');
/* getEntryName() retrieves the neXtProt ID from url. for example, if the url is 
 * https://www.nextprot.org/entry/NX_O14894/gh/zhanglabs/COFACTOR
 * the neXtProt ID is NX_O14894. if the url does not follow such pattern,
 * an abitrary neXtProt ID will be returned, such as NX_P01308 */
var ID = nx.getEntryName();
var href_root = 'https://zhanglab.ccmb.med.umich.edu/COFACTOR/nx2019addition/html/';
var href = href_root+ID;
var cgi = 'https://zhanglab.ccmb.med.umich.edu/C-I-TASSER/bin/receive_nx.cgi'

//var list_txt=IO('list.txt');
var list_txt=IO(href_root+'list');

if (list_txt.includes(ID))
{
    document.getElementById('txt').innerHTML=
        'Loading I-TASSER/COFACTOR data for neXtProt ID '
        +ID+'<br>If this page does not redirect automatically, click <br><a href='
        +href+'>'+href+'</a>';
    window.location.href = href;
}
else
{
    nx.getProteinSequence(ID).then(function(isoforms)
    {
	var sequence='';
	for (var i=0;i<isoforms.length;i++)
	{
	    if (isoforms[i].canonicalIsoform==false) continue;
	    sequence=isoforms[i].sequence;
	    //console.log(isoforms[i]);
	}
	if (sequence.length>750 || sequence.length<10)
	{
    	    document.getElementById('txt').innerHTML='Sorry, your sequence has '+sequence.length+' residues.<br>Due to technical difficulties, we only currently support sequences ranging from 10 to 750 residues<br>';
	    document.getElementById('email_form').style.display='none';
	    return sequence;
	}
        var htmltxt='The analysis for '+ID+' is not computed yet.<br>We can model it for you.<br>The process requires a few days.<br>Enter your email here, and we will let you know when it is ready.<p></p>Submitting neXtProt sequence:<br>&gt;'+ID+'<br>';
	for (var j=0;j<sequence.length;j++)
	{
	    htmltxt+=sequence[j];
	    if ((j+1)%50==0) htmltxt+="<br>\n";
	}
	htmltxt+="<br><p></p>\n";
    	document.getElementById('txt').innerHTML=htmltxt;
	document.getElementById('email_form').action = cgi+'?SEQUENCE='+sequence+'&TARGET='+ID
	return sequence;
    });
}
</script>
